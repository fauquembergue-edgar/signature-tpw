<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Signature du document</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    .legend { margin-bottom: 15px; }
    .pdf-wrapper { position: relative; display: inline-block; }
    canvas { border: 1px solid #ccc; background: #fff; }
    .zone {
      position: absolute;
      border: 2px dashed;
      background: rgba(255,255,255,0.9);
      font-size: 13px;
      z-index: 10;
      transform: none;
      cursor: pointer;
      box-sizing: border-box;
      padding: 0 !important;
      margin: 0 !important;
      line-height: 1 !important;
      transition: left 0.1s, top 0.1s, width 0.1s, height 0.1s;
    }
    .zone.locked {
      pointer-events: none;
      opacity: 0.5;
      cursor: default;
    }
    .legend-box { display: inline-block; width: 12px; height: 12px; margin-right: 5px; }
    #input-area {
      margin-top: 20px;
      pointer-events: none;
    }
    #submit-btn { display: none; margin-top: 20px; padding: 10px 20px; }
    @media (max-width: 600px) {
      #pdf-canvas, .pdf-wrapper {
        width: 100% !important;
        height: auto !important;
        max-width: 100vw;
      }
      .zone {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <h2>Signature du document</h2>

  <div class="legend">
    <strong>Vos zones à remplir sont en :</strong>
    <span class="legend-box" style="background-color: #FF5733;"></span> Orange
  </div>

  <div class="pdf-wrapper" id="pdf-container">
    <canvas id="pdf-canvas"></canvas>
  </div>

  <div id="input-area"></div>
  <div style="margin-top:20px;">
    <label for="final-message"><strong>Message à joindre (optionnel) :</strong></label><br>
    <textarea id="final-message" rows="3" cols="50" placeholder="Un commentaire pour tous les destinataires…"></textarea>
  </div>
  <button id="submit-btn">Valider et envoyer</button>

<script>
const sessionId = "{{ session_id }}";
const step = {{ step }};
const signerNum = {{ signer_num }}; // Numéro du signataire courant (1, 2, 3, ...)
const fields = {{ fields_all | tojson }};
const inputArea = document.getElementById('input-area');
const submitBtn = document.getElementById('submit-btn');
let completed = fields.map(f => f.signed);

const canvas = document.getElementById('pdf-canvas');
const ctx = canvas.getContext('2d');
const container = document.getElementById('pdf-container');

function initSigCanvasMobileDesktop(canvas) {
  const ctx = canvas.getContext('2d');
  let drawing = false, last = {x: 0, y: 0};

  function getXY(e) {
    const rect = canvas.getBoundingClientRect();
    let x, y;
    if (e.touches && e.touches.length === 1) {
      x = (e.touches[0].clientX - rect.left) * (canvas.width / rect.width);
      y = (e.touches[0].clientY - rect.top) * (canvas.height / rect.height);
    } else if (e.offsetX !== undefined) {
      x = e.offsetX * (canvas.width / rect.width);
      y = e.offsetY * (canvas.height / rect.height);
    }
    return {x, y};
  }

  canvas.addEventListener('mousedown', e => { drawing = true; last = getXY(e); });
  canvas.addEventListener('mousemove', e => {
    if (!drawing) return;
    const xy = getXY(e);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(xy.x, xy.y);
    ctx.stroke();
    last = xy;
  });
  canvas.addEventListener('mouseup', () => { drawing = false; });
  canvas.addEventListener('mouseout', () => { drawing = false; });

  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    drawing = true;
    last = getXY(e);
  });
  canvas.addEventListener('touchmove', e => {
    if (!drawing) return;
    e.preventDefault();
    const xy = getXY(e);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(xy.x, xy.y);
    ctx.stroke();
    last = xy;
  });
  canvas.addEventListener('touchend', e => {
    e.preventDefault();
    drawing = false;
  });
  canvas.addEventListener('touchcancel', e => {
    e.preventDefault();
    drawing = false;
  });

  return () => ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function renderZones() {
  const scale = canvas.getBoundingClientRect().width / canvas.width;
  document.querySelectorAll('.zone').forEach(z => z.remove());

  fields.forEach((f, index) => {
    if (f.type === 'statictext') return;

    const zone = document.createElement('div');
    zone.className = 'zone';
    zone.style.left   = (f.x * scale) + "px";
    zone.style.top    = (f.y * scale) + "px";
    zone.style.width  = ((f.w || 100) * scale) + "px";
    zone.style.height = ((f.h || 40) * scale) + "px";
    zone.dataset.type  = f.type;
    zone.dataset.index = index;
    zone.dataset.signer_num = f.signer_num;

    if (f.type === 'signature') {
      zone.textContent = 'Signature';
    } else if (f.type === 'text') {
      zone.textContent = 'Texte';
    } else if (f.type === 'checkbox') {
      zone.textContent = '☐';
    }

    // Couleur et accès UNIQUEMENT sur le numéro de signataire !
    if (f.signer_num !== signerNum) zone.classList.add('locked');
    if (f.type !== 'statictext')
      zone.style.borderColor = (f.signer_num === signerNum) ? '#FF5733' : '#ccc';

    container.appendChild(zone);

    if (f.signer_num === signerNum) {
      zone.addEventListener('click', () => handleClick(zone, f.type, index));
    }
  });
}

window.addEventListener('resize', renderZones);

pdfjsLib.getDocument("/uploads/{{ pdf }}").promise.then(pdf =>
  pdf.getPage(1).then(page => {
    const viewport = page.getViewport({ scale: 1 });
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    canvas.style.width = "100%";
    canvas.style.height = "auto";
    return page.render({ canvasContext: ctx, viewport }).promise;
  })
).then(renderZones);

function handleClick(zone, type, index) {
  inputArea.innerHTML = '';
  inputArea.style.pointerEvents = 'none';

  if (type === 'text') {
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Votre réponse';
    const submit = document.createElement('button');
    submit.textContent = 'Valider';
    submit.onclick = () => {
      fetch('/fill-field', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: sessionId,
          step: step,
          field_index: index,
          value: input.value,
          x_px: fields[index].x,
          y_px: fields[index].y,
          field_height: fields[index].h || 40,
          html_width_px: canvas.width,
          html_height_px: canvas.height
        })
      }).then(() => {
        zone.textContent = input.value;
        zone.style.border = '2px solid green';
        zone.classList.add('locked');
        completed[index] = true;
        inputArea.innerHTML = '';
        checkCompletion();
      });
    };
    inputArea.appendChild(input);
    inputArea.appendChild(submit);
    inputArea.style.pointerEvents = 'auto';
    input.style.pointerEvents = 'auto';
    submit.style.pointerEvents = 'auto';
  }
  else if (type === 'signature') {
    inputArea.style.pointerEvents = 'auto';
    inputArea.innerHTML = `
      <p>Signature :</p>
      <input type="file" id="sigFile" accept="image/png" style="pointer-events:auto;">
      <button id="sigFileBtn" style="pointer-events:auto;">Valider image</button><br><br>
      <canvas id="sigCanvas" width="300" height="100" style="border:1px solid #ccc;display:block;margin-bottom:7px;touch-action:none;"></canvas><br>
      <button id="sigClearBtn" style="pointer-events:auto;">Effacer</button>
      <button id="sigDrawBtn" style="pointer-events:auto;">Valider dessin</button>
    `;
    document.getElementById('sigFileBtn').onclick = () => sendSigFile(index);
    document.getElementById('sigDrawBtn').onclick = () => sendSigDraw(index);
    const clear = initSigCanvasMobileDesktop(document.getElementById('sigCanvas'));
    document.getElementById('sigClearBtn').onclick = clear;
  }
  else if (type === 'checkbox') {
    inputArea.style.pointerEvents = 'auto';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.style.pointerEvents = 'auto';

    const submit = document.createElement('button');
    submit.textContent = 'Valider';
    submit.style.pointerEvents = 'auto';
    submit.onclick = () => {
      fetch('/fill-field', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: sessionId,
          step: step,
          field_index: index,
          value: checkbox.checked,
          x_px: fields[index].x,
          y_px: fields[index].y,
          field_height: fields[index].h || 15,
          html_width_px: canvas.width,
          html_height_px: canvas.height
        })
      }).then(() => {
        zone.textContent = checkbox.checked ? '☑' : '☐';
        zone.style.border = '2px solid green';
        zone.classList.add('locked');
        completed[index] = true;
        inputArea.innerHTML = '';
        checkCompletion();
      });
    };

    inputArea.appendChild(checkbox);
    inputArea.appendChild(submit);
  }
}

function sendSigFile(index) {
  const file = document.getElementById('sigFile').files[0];
  const reader = new FileReader();
  reader.onload = () => {
    fetch('/fill-field', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        session_id: sessionId,
        step: step,
        field_index: index,
        value: reader.result,
        x_px: fields[index].x,
        y_px: fields[index].y,
        field_height: fields[index].h || 40,
        html_width_px: canvas.width,
        html_height_px: canvas.height
      })
    }).then(() => updateZone(index));
  };
  if (file) reader.readAsDataURL(file);
}

function sendSigDraw(index) {
  const canvasDraw = document.getElementById('sigCanvas');
  const ctxDraw = canvasDraw.getContext('2d');
  const imageData = ctxDraw.getImageData(0, 0, canvasDraw.width, canvasDraw.height).data;
  let isBlank = true;
  for (let i = 0; i < imageData.length; i++) {
    if (imageData[i] !== 0) { isBlank = false; break; }
  }
  if (isBlank) {
    alert("Merci de signer dans la zone prévue !");
    return;
  }
  const dataURL = canvasDraw.toDataURL('image/png');
  fetch('/fill-field', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      session_id: sessionId,
      step: step,
      field_index: index,
      value: dataURL,
      x_px: fields[index].x,
      y_px: fields[index].y,
      field_height: fields[index].h || 40,
      html_width_px: canvas.width,
      html_height_px: canvas.height
    })
  }).then(() => updateZone(index));
}

function updateZone(index) {
  const zone = document.querySelector(`.zone[data-index='${index}']`);
  zone.textContent = '✅';
  zone.style.border = '2px solid green';
  zone.classList.add('locked');
  completed[index] = true;
  inputArea.innerHTML = '';
  checkCompletion();
}

function checkCompletion() {
  const mustSign = fields.filter(f => f.signer_num === signerNum && f.type !== 'statictext');
  const allDone = mustSign.every(f => completed[ fields.indexOf(f) ]);
  if (allDone) submitBtn.style.display = 'inline-block';
}

submitBtn.onclick = () => {
  const finalMessage = document.getElementById('final-message').value;
  fetch('/finalise-signature', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id: sessionId, message_final: finalMessage })
  }).then(() => {
    alert("Signature finalisée. Vous pouvez fermer cette page.");
  });
};
</script>
</body>
</html>
