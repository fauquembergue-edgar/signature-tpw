<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Signature du document - TPW Nord Concassage</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <!-- Désactive le zoom navigateur pour éviter tout conflit -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { font-family: 'Roboto', Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    .zoom-controls {
      margin-bottom: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .zoom-btn {
      font-size: 1.3em;
      background: #338DFF;
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 4px 14px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      transition: background .15s;
    }
    .zoom-btn:active, .zoom-btn:hover {
      background: #0f3152;
    }
    .zoom-label {
      font-size: 1em;
      color: #144372;
      font-weight: 500;
      min-width: 60px;
    }
    .pdf-zoom-scroll {
      width: 100vw;
      max-width: 100vw;
      overflow: auto;
      /* Pour éviter de scroller tout le body sur zoom */
      background: #eaeaea;
      padding-bottom: 24px;
    }
    .pdf-zoom-wrapper {
      position: relative;
      display: inline-block;
      /* transform: scale(x) appliqué dynamiquement */
      transform-origin: top left;
      will-change: transform;
      transition: transform 0.10s;
    }
    .pdf-wrapper {
      position: relative;
      display: block;
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
    }
    canvas { border: 1px solid #ccc; background: #fff; width: 100% !important; height: auto !important; display: block; }
    .zone {
      position: absolute;
      border: 2px dashed #FF5733;
      background: rgba(255,255,255,0.9);
      font-size: 14px;
      z-index: 10;
      cursor: pointer;
      box-sizing: border-box;
      padding: 0 !important;
      margin: 0 !important;
      line-height: 1 !important;
      transition: box-shadow .1s;
    }
    .zone.signed {
      border: 2px solid #33C964;
      background: rgba(240,255,240,0.7);
      color: #33C964;
      cursor: not-allowed;
      pointer-events: none;
    }
    .zone.editing {
      box-shadow: 0 0 12px #338DFF77;
      z-index: 100;
    }
    .zone input, .zone textarea {
      width: 100%;
      height: 100%;
      font-size: 1em;
      border: 1.5px solid #338DFF;
      border-radius: 3px;
      background: #fff;
      color: #181c55;
      outline: none;
      box-sizing: border-box;
    }
    .zone .inline-canvas {
      width: 100%; height: 100%;
      border-radius: 3px;
      background: #f8fafb;
      border: 1.5px solid #338DFF;
      display: block;
    }
    .zone .sig-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      margin-top: 2px;
    }
    .zone .sig-actions button {
      font-size: 0.9em;
      padding: 2px 8px;
      border-radius: 3px;
      border: none;
      background: #338DFF;
      color: #fff;
      cursor: pointer;
    }
    .checkbox-real {
      width: 20px;
      height: 20px;
      vertical-align: middle;
      accent-color: #FF5733;
    }
    .previous-message {
      background: #eef;
      border-left: 4px solid #338DFF;
      color: #338DFF;
      padding: 8px 10px;
      margin-bottom: 10px;
      max-width: 500px;
    }
    .msg-final-section {
      margin: 24px 0 6px 0;
      max-width: 500px;
    }
    #submit-btn {
      display: inline-block;
      margin-top: 18px;
      padding: 10px 24px;
      font-size: 1.08em;
      background: #144372;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 500;
      transition: background .18s;
      box-shadow: 0 1px 2px #0002;
    }
    #submit-btn:active, #submit-btn:hover {
      background: #0f3152;
    }
    @media (max-width: 740px) {
      .pdf-wrapper { width: 98vw !important; height: auto !important; max-width: 100vw; }
      .pdf-zoom-scroll { width: 100vw !important; max-width: 100vw !important; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <h2>Signature du document</h2>
  <div class="zoom-controls">
    <button class="zoom-btn" id="zoom-out">-</button>
    <span class="zoom-label" id="zoom-label">100%</span>
    <button class="zoom-btn" id="zoom-in">+</button>
  </div>
  <div class="pdf-zoom-scroll">
    <div class="pdf-zoom-wrapper" id="pdf-zoom-wrapper">
      <div class="pdf-wrapper" id="pdf-container">
        <canvas id="pdf-canvas"></canvas>
      </div>
    </div>
  </div>

  {% if previous_message %}
    <div class="previous-message">
      <strong>Message du signataire précédent&nbsp;:</strong><br>
      {{ previous_message }}
    </div>
  {% endif %}
  <div class="msg-final-section">
    <label for="message-final"><strong>Message au prochain signataire (optionnel) :</strong></label><br>
    <textarea id="message-final" rows="3" cols="50" placeholder="Un commentaire pour le prochain signataire…"></textarea>
  </div>
  <button id="submit-btn">Valider toutes mes zones et envoyer</button>

<script>
const sessionId = "{{ session_id }}";
const step = {{ step }};
const fields = {{ fields_all | tojson }};
const currentSignerId = {{ signer_id }};
let completed = fields.map(f => f.signed);

const canvas = document.getElementById('pdf-canvas');
const container = document.getElementById('pdf-container');
const submitBtn = document.getElementById('submit-btn');
const zoomWrapper = document.getElementById('pdf-zoom-wrapper');
const zoomLabel = document.getElementById('zoom-label');
const zoomInBtn = document.getElementById('zoom-in');
const zoomOutBtn = document.getElementById('zoom-out');

let baseScale = 1.5;
let zoom = 1.0;
const ZOOM_MIN = 0.5;
const ZOOM_MAX = 3.0;
const ZOOM_STEP = 0.15;

// Fixe la transform du wrapper sans reload PDF
function updateZoomTransform() {
  zoomWrapper.style.transform = `scale(${zoom})`;
  zoomWrapper.style.transformOrigin = "top left";
  zoomLabel.innerText = Math.round(zoom * 100) + "%";
  // scroll auto pour centrer le PDF après zoom
  const scroll = document.querySelector('.pdf-zoom-scroll');
  if (scroll) {
    // On garde le PDF visible dans la fenêtre
    scroll.scrollLeft = 0;
    scroll.scrollTop = 0;
  }
}

zoomInBtn.onclick = function() {
  zoom = Math.min(zoom + ZOOM_STEP, ZOOM_MAX);
  updateZoomTransform();
};
zoomOutBtn.onclick = function() {
  zoom = Math.max(zoom - ZOOM_STEP, ZOOM_MIN);
  updateZoomTransform();
};

function computeBaseScale(page) {
  const maxWidth = Math.min(window.innerWidth * 0.98, 700);
  const viewport = page.getViewport({ scale: 1 });
  return maxWidth / viewport.width;
}

function renderZones() {
  document.querySelectorAll('.zone').forEach(z => z.remove());
  fields.forEach((f, index) => {
    if (f.type === 'statictext') return;
    if (f.signer_id != currentSignerId) return;
    const zone = document.createElement('div');
    zone.className = 'zone';
    if (f.signed) zone.classList.add('signed');
    zone.style.left   = (f.x * baseScale) + "px";
    zone.style.top    = (f.y * baseScale) + "px";
    zone.style.width  = ((f.w || 100) * baseScale) + "px";
    zone.style.height = ((f.h || 40) * baseScale) + "px";
    zone.dataset.type  = f.type;
    zone.dataset.index = index;
    zone.dataset.signer_id = f.signer_id;
    if (f.signed) {
      if (f.type === 'text') {
        zone.textContent = f.value;
      }
      if (f.type === 'signature') {
        let img = document.createElement('img');
        img.src = f.value;
        img.style.width = "100%"; img.style.height = "100%";
        img.style.objectFit = "contain";
        zone.appendChild(img);
      }
      if (f.type === 'checkbox') {
        zone.textContent = f.value === true || f.value === "true" || f.value === "on" ? "☑" : "☐";
      }
      container.appendChild(zone);
      return;
    }
    if (f.signer_id == currentSignerId) {
      zone.addEventListener('click', function(e) {
        e.stopPropagation();
        startEditZone(zone, f, index);
      });
    }
    if (f.type === "text") zone.textContent = "Zone de texte";
    if (f.type === "signature") zone.textContent = "Signature";
    if (f.type === "checkbox") zone.textContent = "☐";
    container.appendChild(zone);
  });
}

function startEditZone(zone, field, index) {
  if (zone.classList.contains('editing')) return;
  zone.innerHTML = "";
  zone.classList.add('editing');
  if (field.type === "text") {
    let input = document.createElement('input');
    input.type = "text";
    input.value = field.value || "";
    input.placeholder = "Entrez le texte…";
    input.autofocus = true;
    input.onkeydown = function(e) {
      if (e.key === "Enter") validateInlineText();
      if (e.key === "Escape") cancelInlineEdit();
    };
    input.onblur = function() { validateInlineText(); };
    zone.appendChild(input);
    input.focus();
    function validateInlineText() {
      let val = input.value.trim();
      if (!val) { cancelInlineEdit(); return; }
      fetch('/fill-field', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: sessionId,
          step: step,
          field_index: index,
          value: val,
          x_px: field.x,
          y_px: field.y,
          field_height: field.h || 40,
          html_width_px: canvas.width,
          html_height_px: canvas.height
        })
      }).then(() => {
        fields[index].value = val;
        fields[index].signed = true;
        renderZones();
        checkCompletion();
      });
    }
    function cancelInlineEdit() { renderZones(); }
  }
  else if (field.type === "signature") {
    let signCanvas = document.createElement('canvas');
    signCanvas.width = zone.offsetWidth;
    signCanvas.height = zone.offsetHeight-28;
    signCanvas.className = "inline-canvas";
    let ctx = signCanvas.getContext("2d");
    let drawing = false, last = null;
    signCanvas.addEventListener('mousedown', e => { drawing = true; last = getXY(e, signCanvas); });
    signCanvas.addEventListener('mousemove', e => {
      if (!drawing) return;
      let xy = getXY(e, signCanvas);
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(xy.x, xy.y);
      ctx.stroke();
      last = xy;
    });
    signCanvas.addEventListener('mouseup', () => { drawing = false; });
    signCanvas.addEventListener('mouseout', () => { drawing = false; });
    signCanvas.addEventListener('touchstart', e => { drawing = true; last = getXY(e, signCanvas, true); });
    signCanvas.addEventListener('touchmove', e => {
      if (!drawing) return;
      let xy = getXY(e, signCanvas, true);
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(xy.x, xy.y);
      ctx.stroke();
      last = xy;
    });
    signCanvas.addEventListener('touchend', () => { drawing = false; });
    signCanvas.addEventListener('touchcancel', () => { drawing = false; });
    function getXY(e, can, isTouch) {
      const rect = can.getBoundingClientRect();
      let x, y;
      if (isTouch && e.touches && e.touches.length === 1) {
        x = (e.touches[0].clientX - rect.left) * (can.width / rect.width);
        y = (e.touches[0].clientY - rect.top) * (can.height / rect.height);
      } else if (e.offsetX !== undefined) {
        x = e.offsetX * (can.width / rect.width);
        y = e.offsetY * (can.height / rect.height);
      }
      return {x, y};
    }
    zone.appendChild(signCanvas);

    let actions = document.createElement('div');
    actions.className = "sig-actions";
    let clearBtn = document.createElement('button');
    clearBtn.textContent = "Effacer";
    clearBtn.onclick = function(e) { ctx.clearRect(0,0,signCanvas.width,signCanvas.height); };
    let validerBtn = document.createElement('button');
    validerBtn.textContent = "Valider";
    validerBtn.onclick = function(e) {
      let imgData = ctx.getImageData(0,0,signCanvas.width,signCanvas.height).data;
      let isBlank = true;
      for(let i=0;i<imgData.length;i++) if(imgData[i]!==0) { isBlank=false; break;}
      if (isBlank) { alert("Merci de signer dans la zone !"); return; }
      let dataURL = signCanvas.toDataURL("image/png");
      fetch('/fill-field', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: sessionId,
          step: step,
          field_index: index,
          value: dataURL,
          x_px: field.x,
          y_px: field.y,
          field_height: field.h || 40,
          html_width_px: canvas.width,
          html_height_px: canvas.height
        })
      }).then(() => {
        fields[index].value = dataURL;
        fields[index].signed = true;
        renderZones();
        checkCompletion();
      });
    };
    let cancelBtn = document.createElement('button');
    cancelBtn.textContent = "Annuler";
    cancelBtn.onclick = function(e) { renderZones(); };
    actions.appendChild(clearBtn);
    actions.appendChild(validerBtn);
    actions.appendChild(cancelBtn);
    zone.appendChild(actions);
  }
  else if (field.type === "checkbox") {
    let checkbox = document.createElement('input');
    checkbox.type = "checkbox";
    checkbox.className = "checkbox-real";
    checkbox.checked = field.value === true || field.value === "true" || field.value === "on";
    let validerBtn = document.createElement('button');
    validerBtn.textContent = "Valider";
    validerBtn.onclick = function() {
      fetch('/fill-field', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: sessionId,
          step: step,
          field_index: index,
          value: checkbox.checked,
          x_px: field.x,
          y_px: field.y,
          field_height: field.h || 15,
          html_width_px: canvas.width,
          html_height_px: canvas.height
        })
      }).then(() => {
        fields[index].value = checkbox.checked;
        fields[index].signed = true;
        renderZones();
        checkCompletion();
      });
    };
    zone.appendChild(checkbox);
    zone.appendChild(validerBtn);
  }
}

function checkCompletion() {
  const mustSign = fields.filter(f => f.signer_id == currentSignerId && f.type !== 'statictext');
  const allDone = mustSign.every(f => f.signed);
  submitBtn.style.display = allDone ? 'inline-block' : 'none';
}

submitBtn.onclick = () => {
  const finalMessage = document.getElementById('message-final').value;
  fetch('/finalise-signature', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id: sessionId, message_final: finalMessage })
  }).then(() => {
    alert("Signature finalisée. Vous pouvez fermer cette page.");
    submitBtn.disabled = true;
  });
};

function renderPDF() {
  pdfjsLib.getDocument("/uploads/{{ pdf }}").promise.then(pdf =>
    pdf.getPage(1).then(page => {
      baseScale = computeBaseScale(page);
      const viewport = page.getViewport({ scale: baseScale });
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      canvas.style.width = "100%";
      canvas.style.height = "auto";
      container.style.width = canvas.width + "px";
      container.style.height = canvas.height + "px";
      const ctx = canvas.getContext('2d');
      page.render({ canvasContext: ctx, viewport }).promise.then(() => {
        renderZones();
        updateZoomTransform();
      });
    })
  );
}

// On recalcule tout à chaque resize pour garder la baseScale correcte
window.addEventListener('resize', renderPDF);

// Empêche double tap zoom sur mobile pour éviter conflit
document.addEventListener('touchstart', function preventZoom(e) {
  if (e.touches.length > 1) {
    e.preventDefault();
  }
}, { passive: false });

renderPDF();
</script>
</body>
</html>
