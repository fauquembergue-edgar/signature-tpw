
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Signature interactive</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f2f2f2; }
    #pdf-container { position: relative; display: inline-block; }
    canvas { border: 1px solid #ccc; }
    .zone {
      position: absolute;
      border: 2px dashed #007BFF;
      padding: 4px;
      background-color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
    }
    .zone.filled {
      background-color: rgba(100, 255, 100, 0.6);
      border-color: green;
      pointer-events: none;
    }
    .btn {
      padding: 10px 15px;
      margin-top: 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      display: none;
    }
  </style>
</head>
<body>

<h2>Remplissez les champs attribu√©s</h2>

<div id="pdf-container">
  <canvas id="pdf-canvas"></canvas>
</div>

<div id="input-box" style="display:none; margin-top:20px;">
  <label id="input-label"></label><br>
  <input type="text" id="text-input" placeholder="Entrez du texte ici">
  <button class="btn" onclick="submitField()">Valider ce champ</button>
</div>

<button id="final-btn" class="btn" onclick="finaliser()">Valider et envoyer</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<script>
const canvas = document.getElementById('pdf-canvas');
const ctx = canvas.getContext('2d');
const pdfContainer = document.getElementById('pdf-container');
const inputBox = document.getElementById('input-box');
const textInput = document.getElementById('text-input');
const inputLabel = document.getElementById('input-label');
const finalBtn = document.getElementById('final-btn');

let fields = {{ fields_json | safe }};
let pdfUrl = "/uploads/{{ pdf }}";
let selectedField = null;

function loadPDF(url) {
  pdfjsLib.getDocument(url).promise.then(pdf => {
    pdf.getPage(1).then(page => {
      const viewport = page.getViewport({ scale: 1.5 });
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const renderContext = {
        canvasContext: ctx,
        viewport: viewport
      };
      page.render(renderContext).promise.then(() => {
        fields.forEach((f, idx) => {
          const zone = document.createElement("div");
          zone.className = "zone" + (f.signed ? " filled" : "");
          zone.style.left = f.x + "px";
          zone.style.top = f.y + "px";
          zone.innerText = f.type.toUpperCase();
          zone.dataset.index = idx;
          if (!f.signed) {
            zone.onclick = () => openInputField(idx);
          }
          pdfContainer.appendChild(zone);
        });
        checkCompletion();
      });
    });
  });
}

function openInputField(index) {
  selectedField = index;
  const f = fields[index];
  inputLabel.innerText = `Champ (${f.type}) pour ${f.email}`;
  textInput.value = "";
  inputBox.style.display = "block";
}

function submitField() {
  const val = textInput.value;
  if (!val || selectedField === null) return;
  const f = fields[selectedField];
  fetch("/fill-field", {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      session_id: "{{ session_id }}",
      step: {{ step }},
      field_index: selectedField,
      value: val
    })
  }).then(res => res.json()).then(data => {
    if (data.status === "ok") {
      document.querySelectorAll('.zone')[selectedField].classList.add("filled");
      document.querySelectorAll('.zone')[selectedField].onclick = null;
      fields[selectedField].signed = true;
      inputBox.style.display = "none";
      checkCompletion();
    }
  });
}

function checkCompletion() {
  const allFilled = fields.every(f => f.signed);
  if (allFilled) {
    finalBtn.style.display = "inline-block";
  }
}

function finaliser() {
  fetch("/finalise-signature", {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id: "{{ session_id }}" })
  }).then(() => {
    window.location.href = "/session/{{ session_id }}/status";
  });
}

loadPDF(pdfUrl);
</script>

</body>
</html>
