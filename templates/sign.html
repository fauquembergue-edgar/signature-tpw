<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Signature du document</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    .legend { margin-bottom: 15px; }
    .pdf-wrapper { position: relative; display: inline-block; }
    canvas { border: 1px solid #ccc; background: #fff; }
    .zone {
      position: absolute;
      border: 2px dashed;
      background: rgba(255,255,255,0.9);
      padding: 4px;
      font-size: 13px;
      z-index: 10;
      transform: none;
      cursor: pointer;
    }
    .zone.locked {
      pointer-events: none;
      opacity: 0.5;
      cursor: default;
    }
    .legend-box { display: inline-block; width: 12px; height: 12px; margin-right: 5px; }
    #input-area {
      margin-top: 20px;
      pointer-events: none;    /* désactive par défaut */
    }
    #submit-btn { display: none; margin-top: 20px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h2>Signature du document</h2>

  <div class="legend">
    <strong>Vos zones à remplir sont en :</strong>
    <span class="legend-box" style="background-color: #FF5733;"></span> Orange
  </div>

  <div class="pdf-wrapper" id="pdf-container">
    <canvas id="pdf-canvas"></canvas>
  </div>

  <div id="input-area"></div>
  <button id="submit-btn">Valider et envoyer</button>

<script>
  const container = document.getElementById('pdf-container');
  const rect      = container.getBoundingClientRect();
  const htmlW     = rect.width, htmlH = rect.height;
  const pdfPW     = 612, pdfPH = 792;
  const scaleX    = pdfPW  / htmlW;
  const scaleY    = pdfPH  / htmlH;

  container.addEventListener('click', async e => {
    const x_px = e.clientX - rect.left;
    const y_px = e.clientY - rect.top;
    const payload = {
      session_id:    '{{ session_id }}',
      field_index:   /* à remplir */,
      value:         /* value */,
      x_px,
      y_px,
      html_height_px: htmlH,
      scale_x:       scaleX,
      scale_y:       scaleY
    };
    const resp = await fetch('/fill-field', {
      method: 'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if ((await resp.json()).status === 'ok') {
      location.reload();
    }
  });
</script>
</body>
</html>
