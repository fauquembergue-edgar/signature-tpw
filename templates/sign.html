<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Signature du document</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    .legend { margin-bottom: 15px; }
    .pdf-wrapper { position: relative; display: inline-block; }
    .zone {
      position: absolute;
      border: 2px dashed;
      background: rgba(255,255,255,0.8);
      padding: 4px;
      font-size: 13px;
      z-index: 10;
    }
    .zone.locked {
      pointer-events: none;
      opacity: 0.5;
    }
    #pdfViewer {
      width: 800px;
      height: 1000px;
      border: none;
    }
    .legend-box { display: inline-block; width: 12px; height: 12px; margin-right: 5px; }
    #input-area { margin-top: 20px; }
    canvas { border: 1px solid #ccc; background: #fff; margin-top: 10px; }
    #submit-btn { display: none; margin-top: 20px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h2>Signature du document</h2>

  <div class="legend">
    <strong>Vos zones à remplir sont en :</strong>
    <span class="legend-box" style="background-color: #FF5733;"></span> Orange
  </div>

  <div class="pdf-wrapper" id="pdf-container">
    <embed id="pdfViewer" src="/uploads/{{ pdf }}" type="application/pdf">
    {% for f in fields_json %}
      <div class="zone {% if f.email != email %}locked{% endif %}"
           style="left:{{ f.x }}px; top:{{ f.y }}px; border-color: {{ '#FF5733' if f.email == email else '#ccc' }};"
           data-type="{{ f.type }}"
           data-index="{{ loop.index0 }}"
           data-email="{{ f.email }}">
        {{ 'Signature' if f.type == 'signature' else 'Texte' }}
      </div>
    {% endfor %}
  </div>

  <div id="input-area"></div>
  <button id="submit-btn">Valider et envoyer</button>

<script>
const sessionId = "{{ session_id }}";
const step = {{ step }};
const signEmail = "{{ email }}";
const zones = document.querySelectorAll('.zone');
const inputArea = document.getElementById('input-area');
const submitBtn = document.getElementById('submit-btn');
const fields = {{ fields_all | tojson }};
let completed = fields.map(f => f.signed);

zones.forEach(zone => {
  const type = zone.dataset.type;
  const index = parseInt(zone.dataset.index);
  const email = zone.dataset.email;

  if (email !== signEmail) return;

  zone.addEventListener('click', () => {
    inputArea.innerHTML = '';

    if (type === 'text') {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Votre réponse';
      const submit = document.createElement('button');
      submit.textContent = 'Valider';
      submit.onclick = () => {
        fetch('/fill-field', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            step: step,
            field_index: index,
            value: input.value
          })
        }).then(() => {
          zone.textContent = input.value;
          zone.style.border = '2px solid green';
          zone.classList.add('locked');
          completed[index] = true;
          inputArea.innerHTML = '';
          checkCompletion();
        });
      };
      inputArea.appendChild(input);
      inputArea.appendChild(submit);
    }

    if (type === 'signature') {
      inputArea.innerHTML = `
        <p>Signature :</p>
        <input type="text" id="sigText" placeholder="Nom complet">
        <button onclick="sendSigText(${index})">Valider texte</button><br><br>
        <input type="file" id="sigFile" accept="image/png">
        <button onclick="sendSigFile(${index})">Valider image</button><br><br>
        <canvas id="sigCanvas" width="300" height="100"></canvas><br>
        <button onclick="sendSigDraw(${index})">Valider dessin</button>
      `;
      const canvas = document.getElementById('sigCanvas');
      const ctx = canvas.getContext('2d');
      let drawing = false;
      canvas.onmousedown = () => { drawing = true; ctx.beginPath(); };
      canvas.onmouseup = () => { drawing = false; };
      canvas.onmousemove = e => {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineWidth = 2;
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
      };
    }
  });
});

function sendSigText(index) {
  const val = document.getElementById('sigText').value;
  fetch('/fill-field', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id: sessionId, step: step, field_index: index, value: val })
  }).then(() => {
    updateZone(index);
  });
}

function sendSigFile(index) {
  const file = document.getElementById('sigFile').files[0];
  const reader = new FileReader();
  reader.onload = () => {
    fetch('/fill-field', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: sessionId, step: step, field_index: index, value: reader.result })
    }).then(() => {
      updateZone(index);
    });
  };
  if (file) reader.readAsDataURL(file);
}

function sendSigDraw(index) {
  const canvas = document.getElementById('sigCanvas');
  const dataURL = canvas.toDataURL('image/png');
  fetch('/fill-field', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id: sessionId, step: step, field_index: index, value: dataURL })
  }).then(() => {
    updateZone(index);
  });
}

function updateZone(index) {
  const zone = document.querySelector(`.zone[data-index='${index}']`);
  zone.textContent = '✅';
  zone.style.border = '2px solid green';
  zone.classList.add('locked');
  completed[index] = true;
  inputArea.innerHTML = '';
  checkCompletion();
}

function checkCompletion() {
  const relevant = fields.filter(f => f.email === signEmail).map(f => f.signed || false);
  const localCompletion = relevant.every((v, i) => completed[i]);
  if (localCompletion) {
    submitBtn.style.display = 'inline-block';
  }
}

submitBtn.onclick = () => {
  fetch('/finalise-signature', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id: sessionId })
  }).then(() => {
    alert("Signature finalisée. Vous pouvez fermer cette page.");
  });
};
</script>
</body>
</html>
