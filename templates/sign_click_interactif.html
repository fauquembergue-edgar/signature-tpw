<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Signer le document</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px; }
    .pdf-container { position: relative; display: inline-block; }
    .zone { position: absolute; border: 2px dashed #007BFF; padding: 5px; background: rgba(255,255,255,0.8); cursor: pointer; }
    #signature-pad { display: none; margin-top: 10px; }
    canvas { border: 1px solid #ccc; background: #fff; }
    #submit-btn { margin-top: 20px; display: none; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
<h1>Remplir les champs du document</h1>
<div class="pdf-container" id="pdfContainer">
  <embed src="/uploads/{{ pdf }}" type="application/pdf" width="800px" height="1000px"/>
  {% for f in fields_json %}
    <div class="zone" style="left: {{ f.x }}px; top: {{ f.y }}px;" data-type="{{ f.type }}" data-index="{{ loop.index0 }}" data-email="{{ f.email }}">
      {{ 'Signature' if f.type == 'signature' else 'Texte' }}
    </div>
  {% endfor %}
</div>

<div id="input-area"></div>

<button id="submit-btn">Valider et envoyer</button>

<script>
const zones = document.querySelectorAll('.zone');
const inputArea = document.getElementById('input-area');
const sessionId = "{{ session_id }}";
const step = {{ step }};
const fields = {{ fields_json | tojson }};
let completed = new Array(fields.length).fill(false);

zones.forEach(zone => {
  zone.addEventListener('click', () => {
    const type = zone.dataset.type;
    const index = parseInt(zone.dataset.index);

    inputArea.innerHTML = '';

    if (type === 'text') {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Entrer un texte';
      const submit = document.createElement('button');
      submit.textContent = 'Valider';
      submit.onclick = () => {
        fetch('/fill-field', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            session_id: sessionId,
            step: step,
            field_index: index,
            value: input.value
          })
        }).then(() => {
          zone.textContent = input.value;
          zone.style.border = '2px solid green';
          zone.style.pointerEvents = 'none';
          completed[index] = true;
          checkAll();
          inputArea.innerHTML = '';
        });
      };
      inputArea.appendChild(input);
      inputArea.appendChild(submit);
    }

    if (type === 'signature') {
      inputArea.innerHTML = `
        <p>Choisissez une méthode de signature :</p>
        <input type="text" id="sigText" placeholder="Signer en texte"><br>
        <button onclick="sendSignatureText(${index})">Valider texte</button><br><br>
        <input type="file" id="sigFile" accept="image/png">
        <button onclick="sendSignatureFile(${index})">Valider PNG</button><br><br>
        <canvas id="sigCanvas" width="300" height="100"></canvas><br>
        <button onclick="sendSignatureCanvas(${index})">Valider dessin</button>
      `;
      const canvas = document.getElementById('sigCanvas');
      const ctx = canvas.getContext('2d');
      let drawing = false;
      canvas.onmousedown = () => drawing = true;
      canvas.onmouseup = () => drawing = false;
      canvas.onmousemove = e => {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineWidth = 2;
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
      };
    }
  });
});

function sendSignatureText(index) {
  const value = document.getElementById('sigText').value;
  fetch('/fill-field', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      session_id: sessionId,
      step: step,
      field_index: index,
      value: value
    })
  }).then(() => {
    zones[index].textContent = 'Signé';
    zones[index].style.border = '2px solid green';
    zones[index].style.pointerEvents = 'none';
    completed[index] = true;
    inputArea.innerHTML = '';
    checkAll();
  });
}

function sendSignatureCanvas(index) {
  const canvas = document.getElementById('sigCanvas');
  const dataURL = canvas.toDataURL('image/png');
  fetch('/fill-field', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      session_id: sessionId,
      step: step,
      field_index: index,
      value: dataURL
    })
  }).then(() => {
    zones[index].textContent = 'Signé';
    zones[index].style.border = '2px solid green';
    zones[index].style.pointerEvents = 'none';
    completed[index] = true;
    inputArea.innerHTML = '';
    checkAll();
  });
}

function sendSignatureFile(index) {
  const file = document.getElementById('sigFile').files[0];
  const reader = new FileReader();
  reader.onload = function() {
    fetch('/fill-field', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        session_id: sessionId,
        step: step,
        field_index: index,
        value: reader.result
      })
    }).then(() => {
      zones[index].textContent = 'Signé';
      zones[index].style.border = '2px solid green';
      zones[index].style.pointerEvents = 'none';
      completed[index] = true;
      inputArea.innerHTML = '';
      checkAll();
    });
  };
  if (file) reader.readAsDataURL(file);
}

function checkAll() {
  if (completed.every(Boolean)) {
    document.getElementById('submit-btn').style.display = 'block';
  }
}

document.getElementById('submit-btn').onclick = () => {
  fetch('/finalise-signature', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ session_id: sessionId })
  }).then(() => {
    alert("Document envoyé au prochain signataire ou finalisé.");
    window.location.href = "/";
  });
};
</script>
</body>
</html>

</body>
</html>
