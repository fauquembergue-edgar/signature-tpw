<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>CrÃ©ation de formulaire - PDF Signature</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; display: flex; }
    canvas { border: 1px solid #aaa; display: block; margin-top: 20px; }
    .btn { padding: 8px 15px; background: #007BFF; color: white; border: none; margin: 5px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    .field-box {
      position: absolute;
      background: white;
      padding: 4px;
      font-size: 12px;
    }
    .legend-box {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 5px;
    }
    .statictext-box {
      border: 2px dashed #338DFF !important;
      background: #e6f0ff !important;
      color: #338DFF !important;
      font-weight: bold;
      font-size: 15px;
    }
  </style>
</head>
<body>

<div id="left">
  <h1>ðŸ“„ CrÃ©ation dâ€™un formulaire Ã  signer</h1>

  <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="pdf" accept=".pdf" required>
    <input type="submit" value="Charger le PDF" class="btn">
  </form>

  <div>
    <strong>Type de champ :</strong><br>
    <button class="btn" onclick="selectType('text')">Zone de texte</button>
    <button class="btn" onclick="selectType('signature')">Zone de signature</button>
    <button class="btn" onclick="selectType('checkbox')">Case Ã  cocher</button>
  </div>

  <div>
    <strong>Ajouter signataire :</strong><br>
    <input type="text" id="new-email" placeholder="Adresse email">
    <button class="btn" onclick="addSignataire()">+ Ajouter</button>
    <div id="signataires-list"></div>
  </div>

  <div>
    <strong>Nom de la demande :</strong><br>
    <input type="text" id="nom-demande" placeholder="Nom du processus">
  </div>

  <div>
    <strong>Message email :</strong><br>
    <textarea id="email-message" placeholder="Message Ã  inclure dans lâ€™emailâ€¦" rows="3" cols="60"></textarea>
  </div>

  <div>
    <strong>Templates :</strong><br>
    <input type="text" id="template-name" placeholder="Nom du template">
    <button class="btn" onclick="saveTemplate()">ðŸ’¾ Sauvegarder</button>
    <select id="template-select">
      <option disabled selected>-- Charger un template --</option>
      {% for t in templates %}
        <option value="{{ t }}">{{ t }}</option>
      {% endfor %}
    </select>
    <button class="btn" onclick="loadTemplate()">ðŸ“‚ Charger</button>
  </div>

  <form id="assign-fields-form" action="/define-fields" method="post">
    <input type="hidden" name="fields_json" id="fields-json">
    <input type="hidden" name="email_message" id="email-message-hidden">
    <input type="hidden" name="nom_demande" id="nom-demande-hidden">
    <button type="submit" class="btn">Envoyer pour signature</button>
  </form>
</div>

<div id="pdf-container" style="position: relative; display: none;">
  <canvas id="pdf-canvas"></canvas>
</div>

<script>
let fields = [];
let fieldId = 0;
let scale = 1.5;
let currentPdf = null;
let currentType = null;
let signataires = [];
const COLORS = ["#FF5733", "#337DFF", "#33C964", "#D633FF", "#FFC300", "#33D6FF"];

const canvas = document.getElementById('pdf-canvas');
const container = document.getElementById('pdf-container');

document.getElementById('upload-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  fetch('/upload', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
      currentPdf = data.filename;
      container.style.display = 'block';
      loadPDF('/uploads/' + data.filename);
    })
    .catch(err => {
      console.error(err);
      alert("Erreur lors de lâ€™upload du PDF.");
    });
});

function loadPDF(url) {
  const loadingTask = pdfjsLib.getDocument(url);
  loadingTask.promise.then(pdfDoc => {
    pdfDoc.getPage(1).then(page => {
      const viewport = page.getViewport({ scale: scale });
      canvas.height = viewport.height;
      canvas.width  = viewport.width;
      const renderContext = {
        canvasContext: canvas.getContext('2d'),
        viewport: viewport
      };
      page.render(renderContext);
    });
  }).catch(err => {
    console.error("Erreur lors du chargement du PDF :", err);
    alert("Impossible de charger le PDF.");
  });
}

function selectType(type) {
  currentType = (type === 'text' ? 'statictext' : type);
}

function addSignataire() {
  const email = document.getElementById('new-email').value.trim();
  if (!email) return;
  signataires.push({ id: signataires.length, email });
  updateSignatairesList();
  document.getElementById('new-email').value = '';
}

function updateSignatairesList() {
  const list = document.getElementById('signataires-list');
  list.innerHTML = '';
  signataires.forEach((s, i) => {
    const label = document.createElement('label');
    label.innerHTML = `
      <input type="radio" name="signataire" value="${s.id}">
      <span class="legend-box" style="background: ${COLORS[i % COLORS.length]};"></span>
      ${s.email}
    `;
    list.appendChild(label);
    list.appendChild(document.createElement('br'));
  });
}

canvas.addEventListener('click', function(event) {
  if (!currentType) return alert("Choisissez un type.");
  let signerId = null;
  let email = null;
  if (currentType !== "statictext") {
    const signerRadio = document.querySelector('input[name="signataire"]:checked');
    if (!signerRadio) return alert("SÃ©lectionnez un signataire.");
    signerId = parseInt(signerRadio.value);
    email = signataires.find(s => s.id === signerId).email;
  }
  const rect = canvas.getBoundingClientRect();
  const x = (event.clientX - rect.left) / scale;
  const y = (event.clientY - rect.top) / scale;
  const id = fieldId++;
  let color = "#338DFF";
  if (currentType !== "statictext") {
    color = COLORS[signerId % COLORS.length];
  }
  let field;
  if (currentType === "statictext") {
    const value = prompt("Texte Ã  afficher dans la zone ?");
    if (!value) return;
    field = { id, type: currentType, x, y, value };
  } else {
    field = { id, type: currentType, signer_id: signerId, x, y, signed: false };
  }
  fields.push(field);
  const div = document.createElement('div');
  div.className = 'field-box';
  if (currentType === "statictext") {
    div.classList.add('statictext-box');
    div.innerText = field.value;
  } else {
    div.innerText = currentType.toUpperCase();
  }
  div.style.left = (x * scale) + 'px';
  div.style.top = (y * scale) + 'px';
  div.style.border = `2px dashed ${color}`;
  const removeBtn = document.createElement('button');
  removeBtn.innerText = 'Ã—';
  removeBtn.className = 'btn';
  removeBtn.onclick = function() {
    const idx = fields.findIndex(f => f.id === id);
    if (idx !== -1) fields.splice(idx, 1);
    div.remove();
  };
  div.appendChild(removeBtn);
  container.appendChild(div);
  enableDrag(div, id);
});

function enableDrag(element, id) {
  let offsetX, offsetY;
  element.onmousedown = function(e) {
    offsetX = e.clientX - parseInt(element.style.left);
    offsetY = e.clientY - parseInt(element.style.top);
    function moveAt(ev) {
      const x = (ev.clientX - offsetX) / scale;
      const y = (ev.clientY - offsetY) / scale;
      element.style.left = (x * scale) + 'px';
      element.style.top = (y * scale) + 'px';
      const updated = fields.find(f => f.id === id);
      if (updated) { updated.x = x; updated.y = y; }
    }
    function onMouseMove(ev) { moveAt(ev); }
    document.addEventListener('mousemove', onMouseMove);
    document.onmouseup = function() {
      document.removeEventListener('mousemove', onMouseMove);
      document.onmouseup = null;
    };
  };
  element.ondragstart = () => false;
}

document.getElementById('assign-fields-form').onsubmit = function() {
  document.getElementById('fields-json').value = JSON.stringify({ pdf: currentPdf, fields: fields });
  document.getElementById('email-message-hidden').value = document.getElementById('email-message').value;
  document.getElementById('nom-demande-hidden').value = document.getElementById('nom-demande').value;
};

function saveTemplate() {
  const name = document.getElementById('template-name').value.trim();
  if (!name || !currentPdf) return alert("Nom ou PDF manquant.");
  const templateFields = fields.map(f => {
    if (f.type === "statictext") {
      return { type: f.type, x: f.x, y: f.y, value: f.value };
    } else {
      return { type: f.type, x: f.x, y: f.y, signer_id: f.signer_id };
    }
  });
  fetch('/save-template', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: name, pdf: currentPdf, fields: templateFields })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'saved') {
      alert("Template enregistrÃ© avec succÃ¨s.");
      fields = [];
    } else {
      alert("Erreur lors de lâ€™enregistrement du template.");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Une erreur rÃ©seau est survenue.");
  });
}

function loadTemplate() {
  const name = document.getElementById('template-select').value;
  fetch('/load-template/' + name)
    .then(res => res.json())
    .then(data => {
      fields = [];
      currentPdf = data.pdf;
      container.style.display = 'block';
      loadPDF('/uploads/' + currentPdf);
      setTimeout(() => {
        data.fields.forEach(field => {
          const id = fieldId++;
          field.id = id;
          fields.push(field);
          const div = document.createElement('div');
          div.className = 'field-box';
          if (field.type === "statictext") {
            div.classList.add('statictext-box');
            div.innerText = field.value;
          } else {
            div.innerText = field.type.toUpperCase();
          }
          div.style.left = (field.x * scale) + 'px';
          div.style.top = (field.y * scale) + 'px';
          let color = "#338DFF";
          if (field.type !== "statictext") {
            color = COLORS[field.signer_id % COLORS.length];
          }
          div.style.border = `2px dashed ${color}`;
          container.appendChild(div);
          enableDrag(div, id);
        });
      }, 500);
    });
}
</script>

</body>
</html>
