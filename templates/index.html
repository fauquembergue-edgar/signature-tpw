<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cr√©ation de formulaire - PDF Signature</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    canvas { border: 1px solid #aaa; display: block; margin-top: 20px; }
    .btn { padding: 8px 15px; background: #007BFF; color: white; border: none; margin: 5px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    .field-box {
      position: absolute;
      border: 2px dashed red;
      background: white;
      padding: 4px;
      font-size: 12px;
      cursor: move;
      z-index: 10;
    }
    .remove-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      width: 20px;
      height: 20px;
      font-size: 12px;
    }
  </style>
</head>
<body>

<h1>üìÑ Cr√©ation d‚Äôun formulaire √† signer</h1>

<form id="upload-form" action="/upload" method="post" enctype="multipart/form-data">
  <input type="file" name="pdf" accept=".pdf" required>
  <input type="submit" value="Charger le PDF" class="btn">
</form>

<!-- Type de champ -->
<div style="margin-top: 15px;">
  <strong>Type de champ :</strong><br>
  <button class="btn" onclick="selectType('text')">Zone de texte</button>
  <button class="btn" onclick="selectType('signature')">Zone de signature</button>
</div>

<!-- Signataires -->
<div style="margin-top: 15px;">
  <strong>Ajouter des signataires :</strong>
  <div id="signataires-list"></div>
  <input type="email" id="new-email" placeholder="Email du signataire">
  <button class="btn" onclick="addSignataire()">Ajouter signataire</button>
</div>

<!-- Message personnalis√© -->
<div style="margin-top: 15px;">
  <strong>Message email :</strong><br>
  <textarea id="email-message" placeholder="Entrez ici le message qui accompagnera l‚Äôemail..." rows="3" cols="60"></textarea>
</div>

<!-- Templates -->
<div style="margin-top: 15px;">
  <strong>Templates :</strong><br>
  <input type="text" id="template-name" placeholder="Nom du template">
  <button class="btn" onclick="saveTemplate()">üíæ Sauvegarder comme template</button>
  <select id="template-select">
    <option disabled selected>-- Charger un template --</option>
    {% for t in templates %}
      <option value="{{ t }}">{{ t }}</option>
    {% endfor %}
  </select>
  <button class="btn" onclick="loadTemplate()">üìÇ Charger</button>
</div>

<!-- Canvas PDF -->
<div id="pdf-container" style="position: relative; display: none;">
  <canvas id="pdf-canvas"></canvas>
</div>

<!-- Formulaire final -->
<form id="assign-fields-form" action="/define-fields" method="post">
  <input type="hidden" name="fields_json" id="fields-json">
  <input type="hidden" name="email_message" id="email-message-hidden">
  <input type="submit" value="üì§ Lancer le processus de signature" class="btn">
</form>

<script>
let fields = [];
let fieldId = 0;
let scale = 1;
let currentPdf = null;
let currentType = null;
let signataires = [];
let canvas = document.getElementById('pdf-canvas');
let container = document.getElementById('pdf-container');

// Upload PDF
document.getElementById('upload-form').onsubmit = function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  fetch('/upload', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
      currentPdf = data.filename;
      container.style.display = 'block';
      loadPDF('/uploads/' + data.filename);
    });
};

function loadPDF(url) {
  const loadingTask = pdfjsLib.getDocument(url);
  loadingTask.promise.then(pdf => {
    pdf.getPage(1).then(page => {
      const viewport = page.getViewport({ scale: scale });
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      const context = canvas.getContext('2d');
      page.render({ canvasContext: context, viewport: viewport });
    });
  });
}

function selectType(type) { currentType = type; }

function addSignataire() {
  const email = document.getElementById('new-email').value.trim();
  if (!email) return;
  const id = signataires.length;
  signataires.push({ id, email });
  updateSignatairesList();
  document.getElementById('new-email').value = '';
}

function updateSignatairesList() {
  const container = document.getElementById('signataires-list');
  container.innerHTML = "";
  signataires.forEach(s => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="radio" name="signataire" value="${s.email}"> Signataire ${s.id + 1} (${s.email})`;
    container.appendChild(label);
    container.appendChild(document.createElement('br'));
  });
}

canvas.addEventListener('click', function(event) {
  if (!currentType) return alert("Choisissez un type de champ.");
  const emailRadio = document.querySelector('input[name="signataire"]:checked');
  if (!emailRadio) return alert("S√©lectionnez un signataire.");
  const email = emailRadio.value;
  const rect = canvas.getBoundingClientRect();
  const x = event.clientX - rect.left;
  const y = event.clientY - rect.top;
  const id = fieldId++;
  const field = { id, type: currentType, email, x, y, signed: false };
  fields.push(field);
  const div = document.createElement('div');
  div.className = 'field-box';
  div.style.left = x + 'px';
  div.style.top = y + 'px';
  div.innerText = currentType.toUpperCase();
  const removeBtn = document.createElement('button');
  removeBtn.innerText = '√ó';
  removeBtn.className = 'remove-btn';
  removeBtn.onclick = function() {
    const index = fields.findIndex(f => f.id === id);
    if (index !== -1) fields.splice(index, 1);
    div.remove();
  };
  div.appendChild(removeBtn);
  container.appendChild(div);
  enableDrag(div, id);
});

function enableDrag(element, id) {
  let offsetX, offsetY;
  element.onmousedown = function (event) {
    offsetX = event.clientX - parseInt(element.style.left);
    offsetY = event.clientY - parseInt(element.style.top);
    function moveAt(e) {
      const x = e.clientX - offsetX;
      const y = e.clientY - offsetY;
      element.style.left = x + 'px';
      element.style.top = y + 'px';
      const updated = fields.find(f => f.id === id);
      if (updated) { updated.x = x; updated.y = y; }
    }
    function onMouseMove(e) { moveAt(e); }
    document.addEventListener('mousemove', onMouseMove);
    document.onmouseup = function () {
      document.removeEventListener('mousemove', onMouseMove);
      document.onmouseup = null;
    };
  };
  element.ondragstart = () => false;
}

document.getElementById('assign-fields-form').onsubmit = function () {
  document.getElementById('fields-json').value = JSON.stringify({
    pdf: currentPdf,
    fields: fields
  });
  document.getElementById('email-message-hidden').value = document.getElementById('email-message').value;
};

// Sauvegarder un template
function saveTemplate() {
  const name = document.getElementById('template-name').value.trim();
  if (!name || !currentPdf) return alert("Nom ou PDF manquant.");
  fetch('/save-template', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: name, pdf: currentPdf, fields: fields })
  }).then(res => res.json()).then(r => alert("Template enregistr√©."));
}

// Charger un template
function loadTemplate() {
  const name = document.getElementById('template-select').value;
  fetch('/load-template/' + name)
    .then(res => res.json())
    .then(data => {
      fields = [];
      currentPdf = data.pdf;
      document.getElementById('pdf-container').style.display = 'block';
      loadPDF('/uploads/' + currentPdf);
      setTimeout(() => {
        data.fields.forEach(field => {
          const id = fieldId++;
          field.id = id;
          fields.push(field);
          const div = document.createElement('div');
          div.className = 'field-box';
          div.style.left = field.x + 'px';
          div.style.top = field.y + 'px';
          div.innerText = field.type.toUpperCase();
          const removeBtn = document.createElement('button');
          removeBtn.innerText = '√ó';
          removeBtn.className = 'remove-btn';
          removeBtn.onclick = function() {
            const index = fields.findIndex(f => f.id === id);
            if (index !== -1) fields.splice(index, 1);
            div.remove();
          };
          div.appendChild(removeBtn);
          container.appendChild(div);
          enableDrag(div, id);
        });
      }, 500);
    });
}
</script>


<div style="position: fixed; top: 20px; right: 20px; width: 400px; background: white; border: 1px solid #ccc; padding: 15px; max-height: 90vh; overflow-y: auto;">
  <h3>üßæ Suivi des signatures</h3>
  <table style="width:100%; font-size: 13px; border-collapse: collapse;">
    <tr style="background-color:#007BFF; color:white;">
      <th>Demande</th>
      <th>Statut</th>
    </tr>
    {% for sid, s in sessions.items() %}
    <tr>
      <td>{{ s.name or 'Sans nom' }}</td>
      <td>
        {% for f in s.fields %}
          {{ f.email }} : {% if f.signed %}‚úÖ{% else %}‚ùå{% endif %}<br>
        {% endfor %}
      </td>
    </tr>
    {% endfor %}
  </table>
</div>

</body>
</html>
