<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>TPW Nord Concassage · Formulaires PDF à signer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --tpw-bleu: #27348b;
      --tpw-rouge: #e30613;
      --tpw-gris: #f7f7fa;
      --tpw-bleu-fonce: #181c55;
      --tpw-btn: #27348b;
      --tpw-btn-hover: #152075;
      --tpw-accent: #e30613;
    }
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: var(--tpw-gris);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      color: var(--tpw-bleu-fonce);
      display: flex;
      flex-direction: column;
    }
    header {
      background: white;
      color: var(--tpw-bleu-fonce);
      padding: 18px 0 10px 0;
      text-align: center;
      border-bottom: 4px solid var(--tpw-rouge);
      box-shadow: 0 2px 16px #0001;
      letter-spacing: 1px;
    }
    header img {
      height: 62px;
      vertical-align: middle;
      margin-bottom: 4px;
    }
    header h1 {
      display: block;
      margin: 12px 0 0 0;
      font-family: 'Montserrat', Arial, sans-serif;
      font-size: 2.1rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--tpw-bleu-fonce);
      text-shadow: 0 2px 8px #0002;
    }
    header .sub {
      font-size: 1.09em;
      margin-top: 0;
      color: var(--tpw-accent);
      letter-spacing: 0.8px;
      font-weight: 500;
      font-family: 'Montserrat', Arial, sans-serif;
    }
    main {
      display: flex;
      flex: 1;
      padding: 38px 4vw 38px 4vw;
      max-width: 1400px;
      margin: 0 auto;
      gap: 36px;
      width: 100%;
    }
    #left {
      flex: 3;
      background: white;
      border-radius: 18px;
      box-shadow: 0 4px 24px #27348b18;
      padding: 38px 32px 32px 32px;
      position: relative;
      margin-bottom: 28px;
      border-top: 7px solid var(--tpw-accent);
    }
    #right {
      flex: 1.1;
      min-width: 320px;
      background: white;
      border-radius: 18px;
      box-shadow: 0 4px 24px #232a3310;
      padding: 24px 20px 18px 20px;
      max-height: 90vh;
      overflow-y: auto;
      border-top: 7px solid var(--tpw-bleu);
    }
    h2 {
      font-family: 'Montserrat', Arial, sans-serif;
      font-size: 1.38rem;
      color: var(--tpw-bleu);
      margin-top: 0;
      margin-bottom: 16px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .btn {
      background: var(--tpw-btn);
      color: #fff !important;
      border: none;
      border-radius: 7px;
      padding: 10px 22px;
      margin: 5px 2px 9px 0;
      font-size: 1rem;
      cursor: pointer;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 500;
      transition: background .17s, box-shadow .12s, color .17s;
      box-shadow: 0 1px 3px #0002;
      outline: none !important;
    }
    .btn:active, .btn:hover {
      background: var(--tpw-btn-hover);
      color: #fff !important;
    }
    .btn-accent {
      background: var(--tpw-accent) !important;
      color: #fff !important;
      font-weight: 700;
      border: none;
    }
    .form-section {
      margin-bottom: 26px;
      background: var(--tpw-gris);
      border-radius: 10px;
      padding: 18px 16px 8px 16px;
      box-shadow: 0 2px 8px #27348b09;
    }
    .form-section label {
      font-weight: 500;
      color: var(--tpw-bleu);
      margin-bottom: 4px;
      display: block;
      font-size: 1.05em;
    }
    .form-section input, .form-section select, .form-section textarea {
      font-size: 1em;
      margin-bottom: 10px;
      width: 100%;
      border: 1.5px solid #c7c7da;
      border-radius: 6px;
      padding: 7px 12px;
      font-family: 'Roboto', Arial, sans-serif;
      background: #f8fafb;
      box-sizing: border-box;
      color: var(--tpw-bleu-fonce);
    }
    .form-section input[type="file"] {
      border: none;
      background: transparent;
      padding-left: 0;
      color: #181c55;
    }
    .legend-box {
      display: inline-block;
      width: 13px;
      height: 13px;
      margin-right: 7px;
      border-radius: 2px;
      vertical-align: middle;
    }
    .statictext-box {
      border: 2px dashed var(--tpw-bleu) !important;
      background: #e6f0ff !important;
      color: var(--tpw-bleu) !important;
      font-weight: bold;
      font-size: 15px;
    }
    .field-box {
      position: absolute;
      background: white;
      padding: 4px;
      font-size: 12px;
      cursor: move;
      z-index: 10;
      border-radius: 6px;
      box-shadow: 0 2px 10px #0001;
      user-select: none;
    }
    .remove-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--tpw-accent);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      width: 20px;
      height: 20px;
      font-size: 12px;
      box-shadow: 0 1px 4px #0002;
      z-index: 12;
    }
    #pdf-container {
      position: relative;
      display: none;
      margin: 28px 0 0 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 24px #27348b13;
    }
    canvas {
      border: 1.5px solid #27348b44;
      display: block;
    }
    #signataires-list label {
      margin-right: 7px;
      margin-bottom: 2px;
      font-size: 0.98em;
    }
    #signataires-list span {
      margin-left: 5px;
      border-radius: 2px;
      width: 12px;
      height: 12px;
      display: inline-block;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      font-size: 13px;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 9px 7px;
      text-align: left;
    }
    th {
      background: var(--tpw-bleu);
      color: white;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 500;
      letter-spacing: 1px;
    }
    tr {
      background: #f6f9fc;
      transition: background .15s;
    }
    tr:hover {
      background: var(--tpw-accent);
      color: white;
    }
    tr:nth-child(even) {
      background: #e9eef4;
    }
    .modal-emails-bg {
      position: fixed;
      z-index: 10000;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(40,40,55,0.25);
      display: flex; align-items: center; justify-content: center;
    }
    .modal-emails-content {
      background: #fff;
      border-radius: 12px;
      padding: 32px 28px 26px 28px;
      box-shadow: 0 6px 48px #0004;
      text-align: center;
      min-width: 220px;
      max-width: 95vw;
    }
    .modal-emails-content h4 {
      margin-top: 0;
      font-family: 'Montserrat', Arial, sans-serif;
      color: #27348b;
      margin-bottom: 18px;
    }
    .modal-emails-content label {
      display: block;
      margin-bottom: 13px;
      font-size: 1.02em;
      color: #181c55;
      text-align: left;
    }
    .modal-emails-content input[type=email] {
      width: 95%;
      margin-top: 4px;
      margin-bottom: 8px;
      font-size: 1.08em;
      padding: 7px 12px;
      border-radius: 6px;
      border: 1.5px solid #c7c7da;
      background: #f8fafb;
    }
    .modal-emails-content .btn {
      margin-top: 12px;
      font-size: 1.11em;
    }
    @media (max-width: 1100px) {
      main { flex-direction: column; gap: 0; padding: 24px 0; }
      #left, #right { max-width: 100vw; border-radius: 0; box-shadow: none; }
      #left { margin-bottom: 32px; }
    }
    @media (max-width: 600px) {
      main { padding: 0; }
      #left, #right { padding: 10px; }
    }
  </style>
</head>
<body>
<header>
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAYAAABkZC3zAAABxUlEQVR4nO3bQY6DMBBF0aRwaT5fZj6B4pQ2q9tq8zT4kI/6p+zK1XnQCAAAAAAAAAAAAoJQkqVSCW25p8nS6bqfJ8VUzv9A6mV8r6VwH+W9QX9w4U4x+3tEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEAAAAAAAAAAAAAAABwH+YHwXyM9BUAAAAASUVORK5CYII=" alt="Logo TPW Nord Concassage">
  <h1>TPW Nord Concassage</h1>
  <div class="sub">
    Digitalisez vos formulaires et signatures PDF
  </div>
</header>
<main>
  <div id="left">
    <h2>Créer un formulaire PDF à signer</h2>
    <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data" class="form-section">
      <label for="pdf">Charger un PDF à annoter</label>
      <input type="file" name="pdf" id="pdf" accept=".pdf" required>
      <input type="submit" value="Charger le PDF" class="btn btn-accent">
    </form>
    <div class="form-section">
      <label for="nom-demande">Nom de la demande :</label>
      <input type="text" id="nom-demande" placeholder="Nom du processus">
    </div>
    <div class="form-section">
      <label for="email-message">Message email :</label>
      <textarea id="email-message" placeholder="Message à inclure dans l’email…" rows="3" cols="60"></textarea>
    </div>
    <div class="form-section">
      <label>Templates :</label>
      <input type="text" id="template-name" placeholder="Nom du template">
      <button class="btn" onclick="saveTemplate()">💾 Sauvegarder</button>
      <select id="template-select">
        <option disabled selected>-- Charger un template --</option>
        {% for t in templates %}
          <option value="{{ t }}">{{ t }}</option>
        {% endfor %}
      </select>
      <button class="btn" onclick="loadTemplate()">📂 Charger</button>
      <ul id="template-list" style="margin:0;padding:0;">
        {% for t in templates %}
          <li style="display:inline-block;margin:0 6px 0 0;">
            <button class="btn btn-accent" onclick="deleteTemplatePrompt('{{ t }}')" style="padding:2px 10px;font-size:0.95em;">🗑 {{ t }}</button>
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="form-section">
      <label>Ajouter des signataires :</label>
      <div id="signataires-list"></div>
      <input type="email" id="new-email" placeholder="Email du signataire">
      <select id="signer-email-select" style="margin:7px 0 0 0;">
        <option value="">-- Emails enregistrés --</option>
        {% for email in signers %}
          <option value="{{ email }}">{{ email }}</option>
        {% endfor %}
      </select>
      <button class="btn" onclick="selectEmailFromList()">Utiliser</button>
      <ul id="signer-list">
        {% for email in signers %}
          <li>
            {{ email }}
            <button class="btn btn-accent" style="padding:1px 7px;font-size:0.95em;" onclick="deleteSignerPrompt('{{ email }}')">🗑</button>
          </li>
        {% endfor %}
      </ul>
      <button class="btn" onclick="addSignataire()">Ajouter signataire</button>
    </div>
    <div class="form-section" id="champ-section" style="margin-bottom: 0;">
      <label>Type de champ à ajouter :</label>
      <button class="btn" onclick="selectType('text')">Zone de texte</button>
      <button class="btn" onclick="selectType('signature')">Zone de signature</button>
      <button class="btn" onclick="selectType('checkbox')">Case à cocher</button>
      <button class="btn btn-accent" onclick="selectType('statictext')">Zone texte statique</button>
      <span style="margin-left:8px; color:#888; font-size:0.95em;">(Cliquez sur le PDF pour placer le champ)</span>
    </div>
    <div id="pdf-container" style="position: relative; display: none;">
      <canvas id="pdf-canvas"></canvas>
    </div>
    <form id="assign-fields-form" action="/define-fields" method="post" class="form-section" style="background:transparent;box-shadow:none;">
      <input type="hidden" name="fields_json" id="fields-json">
      <input type="hidden" name="email_message" id="email-message-hidden">
      <input type="hidden" name="nom_demande" id="nom-demande-hidden">
      <input type="submit" value="📤 Lancer le processus de signature" class="btn btn-accent" style="font-size:1.12em;">
    </form>
  </div>
  <div id="right">
    <h2 style="margin-bottom:18px;"><span style="color:var(--tpw-accent);">🧾</span> Suivi des signatures</h2>
    <table>
      <tr>
        <th>Demande</th>
        <th>Statut</th>
        <th>Action</th>
      </tr>
      {% for sid, s in sessions.items() %}
      <tr>
        <td>{{ s.name or 'Sans nom' }}</td>
        <td>{% if s.done %}✅ Terminé{% else %}⏳ En attente{% endif %}</td>
        <td>
          <button class="btn btn-accent" onclick="deleteSessionPrompt('{{ sid }}')" style="padding:2px 10px;font-size:0.95em;">🗑</button>
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
</main>
<div id="modal-emails-bg" class="modal-emails-bg" style="display:none;">
  <div class="modal-emails-content" id="modal-emails-content"></div>
</div>
<script>
function deleteTemplatePrompt(name) {
  if (confirm('Supprimer ce template ?')) {
    fetch('/delete-template', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name})
    }).then(r=>r.json()).then(data=>{
      if(data.status === 'deleted') location.reload();
    });
  }
}
function deleteSignerPrompt(email) {
  if (confirm('Supprimer cet email ?')) {
    fetch('/delete-signer', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email})
    }).then(r=>r.json()).then(data=>{
      if(data.status === 'deleted') location.reload();
    });
  }
}
function deleteSessionPrompt(session_id) {
  if (confirm('Supprimer cette ligne de suivi ?')) {
    fetch('/delete-session', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({session_id})
    }).then(r=>r.json()).then(data=>{
      if(data.status === 'deleted') location.reload();
    });
  }
}
function selectEmailFromList() {
  const select = document.getElementById('signer-email-select');
  const val = select.value;
  if (val) document.getElementById('new-email').value = val;
}
document.addEventListener('DOMContentLoaded', () => {
  fetch('/get-signers').then(r=>r.json()).then(signers=>{
    const select = document.getElementById('signer-email-select');
    if (select) {
      for (const email of signers) {
        if (![...select.options].map(o=>o.value).includes(email)) {
          const opt = document.createElement('option');
          opt.value = email; opt.textContent = email;
          select.appendChild(opt);
        }
      }
    }
  });
});

let fields = [];
let fieldId = 0;
let scale = 1.5;
let currentPdf = null;
let currentType = null;
let signataires = [];
const COLORS = ["#27348b", "#e30613", "#33C964", "#D633FF", "#FFC300", "#33D6FF"];
const canvas = document.getElementById('pdf-canvas');
const container = document.getElementById('pdf-container');

document.getElementById('upload-form').onsubmit = function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  fetch('/upload', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
      currentPdf = data.filename;
      container.style.display = 'block';
      loadPDF('/uploads/' + data.filename, () => {
        redrawFields();
      });
    });
};

function loadPDF(url, callback) {
  const loadingTask = pdfjsLib.getDocument(url);
  loadingTask.promise.then(pdf => {
    pdf.getPage(1).then(page => {
      const viewport = page.getViewport({ scale });
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      const context = canvas.getContext('2d');
      context.clearRect(0, 0, canvas.width, canvas.height);
      page.render({ canvasContext: context, viewport: viewport }).promise.then(() => {
        if (callback) callback();
      });
    });
  });
}

function selectType(type) { currentType = type; }

function addSignataire() {
  const email = document.getElementById('new-email').value.trim();
  if (!email) return;
  signataires.push({ id: signataires.length, email });
  updateSignatairesList();
  document.getElementById('new-email').value = '';
}

function updateSignatairesList() {
  const container = document.getElementById('signataires-list');
  container.innerHTML = "";
  signataires.forEach((s, i) => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="radio" name="signataire" value="${s.id}"> Signataire ${i + 1} (${s.email}) <span style="background:${COLORS[i % COLORS.length]}; width:10px; height:10px; display:inline-block;"></span>`;
    container.appendChild(label);
    container.appendChild(document.createElement('br'));
  });
}

canvas.addEventListener('click', function(event) {
  if (!currentType) return alert("Choisissez un type.");
  let signerId = null;
  let email = null;
  if (currentType !== "statictext") {
    const signerRadio = document.querySelector('input[name="signataire"]:checked');
    if (!signerRadio) return alert("Sélectionnez un signataire.");
    signerId = parseInt(signerRadio.value);
    email = signataires.find(s => s.id === signerId).email;
  }
  const rect = canvas.getBoundingClientRect();
  const x = (event.clientX - rect.left) / scale;
  const y = (event.clientY - rect.top) / scale;
  const id = fieldId++;
  let color = "#27348b";
  if (currentType !== "statictext") {
    color = COLORS[signerId % COLORS.length];
  }
  let field;
  if (currentType === "statictext") {
    const value = prompt("Texte à afficher dans la zone ?");
    if (!value) return;
    field = { id, type: currentType, x, y, value };
  } else {
    field = { id, type: currentType, signer_id: signerId, email: email, x, y, signed: false };
  }
  fields.push(field);
  addFieldBoxToPDF(field);
});

function addFieldBoxToPDF(field) {
  const div = document.createElement('div');
  div.className = 'field-box';
  if (field.type === "statictext") {
    div.classList.add('statictext-box');
    div.innerText = field.value;
  } else {
    div.innerText = field.type.toUpperCase();
  }
  div.style.left = (field.x * scale) + 'px';
  div.style.top = (field.y * scale) + 'px';
  let color = "#27348b";
  if (field.type !== "statictext") {
    color = COLORS[field.signer_id % COLORS.length];
  }
  div.style.border = `2px dashed ${color}`;
  const removeBtn = document.createElement('button');
  removeBtn.innerText = '×';
  removeBtn.className = 'remove-btn';
  removeBtn.onclick = function() {
    const index = fields.findIndex(f => f.id === field.id);
    if (index !== -1) fields.splice(index, 1);
    div.remove();
  };
  div.appendChild(removeBtn);
  container.appendChild(div);
  enableDrag(div, field.id);
}

function redrawFields() {
  [...container.querySelectorAll('.field-box')].forEach(div => div.remove());
  fields.forEach(field => addFieldBoxToPDF(field));
}

document.getElementById('assign-fields-form').onsubmit = function () {
  if (!currentPdf) {
    alert("Aucun PDF sélectionné !");
    return false;
  }
  const missing = fields.filter(f => f.type !== "statictext" && (!f.email || f.email.trim() === ""));
  if (missing.length > 0) {
    alert("Veuillez renseigner l'email pour chaque signataire avant de lancer le processus.");
    return false;
  }
  document.getElementById('fields-json').value = JSON.stringify({ pdf: currentPdf, fields: fields });
  document.getElementById('email-message-hidden').value = document.getElementById('email-message').value;
  document.getElementById('nom-demande-hidden').value = document.getElementById('nom-demande').value;
  return true;
};

function saveTemplate() {
  const name = document.getElementById('template-name').value.trim();
  if (!name || !currentPdf) return alert("Nom ou PDF manquant.");
  const templateFields = fields.map(f => {
    if (f.type === "statictext") {
      return { type: f.type, x: f.x, y: f.y, value: f.value };
    } else {
      return { type: f.type, x: f.x, y: f.y, signer_id: f.signer_id };
    }
  });
  fetch('/save-template', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: name,
      pdf: currentPdf,
      fields: templateFields
    })
  })
  .then(res => res.json())
  .then(data => {
    alert("Template enregistré.");
  });
}

function loadTemplate() {
  const name = document.getElementById('template-select').value;
  fetch('/load-template/' + name)
    .then(res => res.json())
    .then(data => {
      fields = [];
      fieldId = 0;
      currentPdf = data.pdf;
      container.style.display = 'block';
      loadPDF('/uploads/' + currentPdf, () => {
        [...container.querySelectorAll('.field-box')].forEach(div => div.remove());
        data.fields.forEach(field => {
          const id = fieldId++;
          let newField = { ...field, id };
          if (newField.type !== "statictext") {
            newField.email = "";
            delete newField.value;
            delete newField.signed;
          }
          fields.push(newField);
          addFieldBoxToPDF(newField);
        });
        const signerIds = [...new Set(fields.filter(f => f.type !== "statictext").map(f => f.signer_id))];
        askForSignatairesEmails(signerIds);
      });
    });
}

// Nouvelle version de askForSignatairesEmails avec menu déroulant emails enregistrés
function askForSignatairesEmails(signerIds) {
  signerIds = [...new Set(signerIds)];
  if (signerIds.length === 0) return;
  const modalBg = document.getElementById('modal-emails-bg');
  const modalContent = document.getElementById('modal-emails-content');
  fetch('/get-signers').then(res => res.json()).then(signers => {
    let html = `<h4>Renseignez les emails des signataires :</h4>`;
    signerIds.forEach((id, i) => {
      html += `
        <label>
          Signataire ${parseInt(i)+1} (étape ${id+1}) :
          <input type="email" id="email-sign-${id}" required style="width:60%;">
          <select id="select-email-sign-${id}" style="width:33%;margin-left:4px;">
            <option value="">-- Emails enregistrés --</option>
            ${signers.map(email => `<option value="${email}">${email}</option>`).join('')}
          </select>
          <button type="button" class="btn" style="padding:2px 8px;font-size:0.95em;" onclick="useSavedEmail(${id})">Utiliser</button>
        </label>`;
    });
    html += `<button class="btn btn-accent" id="validate-emails">Valider</button>`;
    modalContent.innerHTML = html;
    modalBg.style.display = "flex";

    document.getElementById('validate-emails').onclick = function() {
      let ok = true;
      let mapping = {};
      signerIds.forEach(id => {
        const val = document.getElementById('email-sign-'+id).value.trim();
        if (!val) ok = false;
        mapping[id] = val;
      });
      if (!ok) return alert("Veuillez renseigner tous les emails.");
      fields.forEach(f => {
        if (f.type !== "statictext" && mapping[f.signer_id] !== undefined) {
          f.email = mapping[f.signer_id];
        }
      });
      signerIds.forEach((id, idx) => {
        let sig = signataires.find(s => s.id === id);
        if (sig) {
          sig.email = mapping[id];
        } else {
          signataires.push({ id: id, email: mapping[id] });
        }
      });
      modalBg.style.display = "none";
      alert("Emails enregistrés pour les signataires.");
    }
  });
}
function useSavedEmail(id) {
  const sel = document.getElementById('select-email-sign-' + id);
  const input = document.getElementById('email-sign-' + id);
  if (sel && input && sel.value) input.value = sel.value;
}
window.useSavedEmail = useSavedEmail;

function enableDrag(element, id) {
  let offsetX, offsetY;
  element.onmousedown = function (event) {
    offsetX = event.clientX - parseInt(element.style.left);
    offsetY = event.clientY - parseInt(element.style.top);
    function moveAt(e) {
      const x = (e.clientX - offsetX) / scale;
      const y = (e.clientY - offsetY) / scale;
      element.style.left = (x * scale) + 'px';
      element.style.top = (y * scale) + 'px';
      const updated = fields.find(f => f.id === id);
      if (updated) { updated.x = x; updated.y = y; }
    }
    function onMouseMove(e) { moveAt(e); }
    document.addEventListener('mousemove', onMouseMove);
    document.onmouseup = function () {
      document.removeEventListener('mousemove', onMouseMove);
      document.onmouseup = null;
    };
  };
  element.ondragstart = () => false;
}
</script>
</body>
</html>
