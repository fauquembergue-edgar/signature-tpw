<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>TPW Nord Concassage · Formulaires PDF à signer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --tpw-bleu: #27348b;
      --tpw-rouge: #e30613;
      --tpw-gris: #f7f7fa;
      --tpw-bleu-fonce: #181c55;
      --tpw-btn: #27348b;
      --tpw-btn-hover: #152075;
      --tpw-accent: #e30613;
    }
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: var(--tpw-gris);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      color: var(--tpw-bleu-fonce);
      display: flex;
      flex-direction: column;
    }
    header {
      background: white;
      color: var(--tpw-bleu-fonce);
      padding: 18px 0 10px 0;
      text-align: center;
      border-bottom: 4px solid var(--tpw-rouge);
      box-shadow: 0 2px 16px #0001;
      letter-spacing: 1px;
    }
    header img {
      height: 62px;
      vertical-align: middle;
      margin-bottom: 4px;
    }
    header h1 {
      display: block;
      margin: 12px 0 0 0;
      font-family: 'Montserrat', Arial, sans-serif;
      font-size: 2.1rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--tpw-bleu-fonce);
      text-shadow: 0 2px 8px #0002;
    }
    header .sub {
      font-size: 1.09em;
      margin-top: 0;
      color: var(--tpw-accent);
      letter-spacing: 0.8px;
      font-weight: 500;
      font-family: 'Montserrat', Arial, sans-serif;
    }
    main {
      display: flex;
      flex: 1;
      padding: 38px 4vw 38px 4vw;
      max-width: 1400px;
      margin: 0 auto;
      gap: 36px;
      width: 100%;
    }
    #left {
      flex: 3;
      background: white;
      border-radius: 18px;
      box-shadow: 0 4px 24px #27348b18;
      padding: 38px 32px 32px 32px;
      position: relative;
      margin-bottom: 28px;
      border-top: 7px solid var(--tpw-accent);
    }
    #right {
      flex: 1.1;
      min-width: 320px;
      background: white;
      border-radius: 18px;
      box-shadow: 0 4px 24px #232a3310;
      padding: 24px 20px 18px 20px;
      max-height: 90vh;
      overflow-y: auto;
      border-top: 7px solid var(--tpw-bleu);
    }
    h2 {
      font-family: 'Montserrat', Arial, sans-serif;
      font-size: 1.38rem;
      color: var(--tpw-bleu);
      margin-top: 0;
      margin-bottom: 16px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .btn {
      background: var(--tpw-btn);
      color: #fff !important;
      border: none;
      border-radius: 7px;
      padding: 10px 22px;
      margin: 5px 2px 9px 0;
      font-size: 1rem;
      cursor: pointer;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 500;
      transition: background .17s, box-shadow .12s, color .17s;
      box-shadow: 0 1px 3px #0002;
      outline: none !important;
    }
    .btn:active, .btn:hover {
      background: var(--tpw-btn-hover);
      color: #fff !important;
    }
    .btn-accent {
      background: var(--tpw-accent) !important;
      color: #fff !important;
      font-weight: 700;
      border: none;
    }
    .form-section {
      margin-bottom: 26px;
      background: var(--tpw-gris);
      border-radius: 10px;
      padding: 18px 16px 8px 16px;
      box-shadow: 0 2px 8px #27348b09;
    }
    .form-section label {
      font-weight: 500;
      color: var(--tpw-bleu);
      margin-bottom: 4px;
      display: block;
      font-size: 1.05em;
    }
    .form-section input, .form-section select, .form-section textarea {
      font-size: 1em;
      margin-bottom: 10px;
      width: 100%;
      border: 1.5px solid #c7c7da;
      border-radius: 6px;
      padding: 7px 12px;
      font-family: 'Roboto', Arial, sans-serif;
      background: #f8fafb;
      box-sizing: border-box;
      color: var(--tpw-bleu-fonce);
    }
    .form-section input[type="file"] {
      border: none;
      background: transparent;
      padding-left: 0;
      color: #181c55;
    }
    .legend-box {
      display: inline-block;
      width: 13px;
      height: 13px;
      margin-right: 7px;
      border-radius: 2px;
      vertical-align: middle;
    }
    .statictext-box {
      border: 2px dashed var(--tpw-bleu) !important;
      background: #e6f0ff !important;
      color: var(--tpw-bleu) !important;
      font-weight: bold;
      font-size: 15px;
    }
    .field-box {
      position: absolute;
      background: white;
      padding: 4px;
      font-size: 12px;
      cursor: move;
      z-index: 10;
      border-radius: 6px;
      box-shadow: 0 2px 10px #0001;
      user-select: none;
    }
    .remove-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--tpw-accent);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      width: 20px;
      height: 20px;
      font-size: 12px;
      box-shadow: 0 1px 4px #0002;
      z-index: 12;
    }
    #pdf-container {
      position: relative;
      display: none;
      margin: 28px 0 0 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 24px #27348b13;
    }
    canvas {
      border: 1.5px solid #27348b44;
      display: block;
    }
    #signataires-list label {
      margin-right: 7px;
      margin-bottom: 2px;
      font-size: 0.98em;
    }
    #signataires-list span {
      margin-left: 5px;
      border-radius: 2px;
      width: 12px;
      height: 12px;
      display: inline-block;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      font-size: 13px;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 9px 7px;
      text-align: left;
    }
    th {
      background: var(--tpw-bleu);
      color: white;
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 500;
      letter-spacing: 1px;
    }
    tr {
      background: #f6f9fc;
      transition: background .15s;
    }
    tr:hover {
      background: var(--tpw-accent);
      color: white;
    }
    tr:nth-child(even) {
      background: #e9eef4;
    }
    @media (max-width: 1100px) {
      main { flex-direction: column; gap: 0; padding: 24px 0; }
      #left, #right { max-width: 100vw; border-radius: 0; box-shadow: none; }
      #left { margin-bottom: 32px; }
    }
    @media (max-width: 600px) {
      main { padding: 0; }
      #left, #right { padding: 10px; }
    }
  </style>
</head>
<body>

<header>
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAYAAABkZC3zAAABxUlEQVR4nO3bQY6DMBBF0aRwaT5fZj6B4pQ2q9tq8zT4kI/6p+zK1XnQCAAAAAAAAAAAAoJQkqVSCW25p8nS6bqfJ8VUzv9A6mV8r6VwH+W9QX9w4U4x+3tEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEtEfEAAAAAAAAAAAAAAABwH+YHwXyM9BUAAAAASUVORK5CYII=" alt="Logo TPW Nord Concassage">
  <h1>TPW Nord Concassage</h1>
  <div class="sub">
    Digitalisez vos formulaires et signatures PDF
  </div>
</header>

<main>
  <div id="left">
    <h2>Créer un formulaire PDF à signer</h2>

    <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data" class="form-section">
      <label for="pdf">Charger un PDF à annoter</label>
      <input type="file" name="pdf" id="pdf" accept=".pdf" required>
      <input type="submit" value="Charger le PDF" class="btn btn-accent">
    </form>

    <div class="form-section">
      <label>Ajouter des signataires :</label>
      <div id="signataires-list"></div>
      <input type="email" id="new-email" placeholder="Email du signataire">
      <button class="btn" onclick="addSignataire()">Ajouter signataire</button>
    </div>

    <div class="form-section">
      <label for="nom-demande">Nom de la demande :</label>
      <input type="text" id="nom-demande" placeholder="Nom du processus">
    </div>

    <div class="form-section">
      <label for="email-message">Message email :</label>
      <textarea id="email-message" placeholder="Message à inclure dans l’email…" rows="3" cols="60"></textarea>
    </div>

    <div class="form-section">
      <label>Templates :</label>
      <input type="text" id="template-name" placeholder="Nom du template">
      <button class="btn" onclick="saveTemplate()">💾 Sauvegarder</button>
      <select id="template-select">
        <option disabled selected>-- Charger un template --</option>
        {% for t in templates %}
          <option value="{{ t }}">{{ t }}</option>
        {% endfor %}
      </select>
      <button class="btn" onclick="loadTemplate()">📂 Charger</button>
    </div>

    <!-- Types de champ à ajouter JUSTE au-dessus du PDF -->
    <div class="form-section" id="champ-section" style="margin-bottom: 0;">
      <label>Type de champ à ajouter :</label>
      <button class="btn" onclick="selectType('text')">Zone de texte</button>
      <button class="btn" onclick="selectType('signature')">Zone de signature</button>
      <button class="btn" onclick="selectType('checkbox')">Case à cocher</button>
      <button class="btn btn-accent" onclick="selectType('statictext')">Zone texte statique</button>
      <span style="margin-left:8px; color:#888; font-size:0.95em;">(Cliquez sur le PDF pour placer le champ)</span>
    </div>

    <div id="pdf-container">
      <canvas id="pdf-canvas"></canvas>
    </div>

    <form id="assign-fields-form" action="/define-fields" method="post" class="form-section" style="background:transparent;box-shadow:none;">
      <input type="hidden" name="fields_json" id="fields-json">
      <input type="hidden" name="email_message" id="email-message-hidden">
      <input type="hidden" name="nom_demande" id="nom-demande-hidden">
      <input type="submit" value="📤 Lancer le processus de signature" class="btn btn-accent" style="font-size:1.12em;">
    </form>
  </div>

  <div id="right">
    <h2 style="margin-bottom:18px;"><span style="color:var(--tpw-accent);">🧾</span> Suivi des signatures</h2>
    <table>
      <tr>
        <th>Demande</th>
        <th>Statut</th>
      </tr>
      {% for sid, s in sessions.items() %}
      <tr>
        <td>{{ s.name or 'Sans nom' }}</td>
        <td>{% if s.done %}✅ Terminé{% else %}⏳ En attente{% endif %}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
</main>

<script>
let fields = [];
let fieldId = 0;
let scale = 1.5;
let currentPdf = null;
let currentType = null;
let signataires = [];
const COLORS = ["#27348b", "#e30613", "#33C964", "#D633FF", "#FFC300", "#33D6FF"];

const canvas = document.getElementById('pdf-canvas');
const container = document.getElementById('pdf-container');

document.getElementById('upload-form').onsubmit = function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  fetch('/upload', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
      currentPdf = data.filename;
      container.style.display = 'block';
      loadPDF('/uploads/' + data.filename);
    });
};

function loadPDF(url) {
  const loadingTask = pdfjsLib.getDocument(url);
  loadingTask.promise.then(pdf => {
    pdf.getPage(1).then(page => {
      const viewport = page.getViewport({ scale });
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      const context = canvas.getContext('2d');
      page.render({ canvasContext: context, viewport: viewport });
    });
  });
}

function selectType(type) { currentType = type; }

function addSignataire() {
  const email = document.getElementById('new-email').value.trim();
  if (!email) return;
  signataires.push({ id: signataires.length, email });
  updateSignatairesList();
  document.getElementById('new-email').value = '';
}

function updateSignatairesList() {
  const container = document.getElementById('signataires-list');
  container.innerHTML = "";
  signataires.forEach((s, i) => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="radio" name="signataire" value="${s.id}"> Signataire ${i + 1} (${s.email}) <span style="background:${COLORS[i % COLORS.length]}; width:10px; height:10px; display:inline-block;"></span>`;
    container.appendChild(label);
    container.appendChild(document.createElement('br'));
  });
}

canvas.addEventListener('click', function(event) {
  if (!currentType) return alert("Choisissez un type.");
  let signerId = null;
  let email = null;
  if (currentType !== "statictext") {
    const signerRadio = document.querySelector('input[name="signataire"]:checked');
    if (!signerRadio) return alert("Sélectionnez un signataire.");
    signerId = parseInt(signerRadio.value);
    email = signataires.find(s => s.id === signerId).email;
  }
  const rect = canvas.getBoundingClientRect();
  const x = (event.clientX - rect.left) / scale;
  const y = (event.clientY - rect.top) / scale;
  const id = fieldId++;
  let color = "#27348b";
  if (currentType !== "statictext") {
    color = COLORS[signerId % COLORS.length];
  }
  let field;
  if (currentType === "statictext") {
    const value = prompt("Texte à afficher dans la zone ?");
    if (!value) return;
    field = { id, type: currentType, x, y, value };
  } else {
    field = { id, type: currentType, signer_id: signerId, email: email, x, y, signed: false };
  }
  fields.push(field);

  const div = document.createElement('div');
  div.className = 'field-box';
  if (currentType === "statictext") {
    div.classList.add('statictext-box');
    div.innerText = field.value;
  } else {
    div.innerText = currentType.toUpperCase();
  }
  div.style.left = (x * scale) + 'px';
  div.style.top = (y * scale) + 'px';
  div.style.border = `2px dashed ${color}`;
  const removeBtn = document.createElement('button');
  removeBtn.innerText = '×';
  removeBtn.className = 'remove-btn';
  removeBtn.onclick = function() {
    const index = fields.findIndex(f => f.id === id);
    if (index !== -1) fields.splice(index, 1);
    div.remove();
  };
  div.appendChild(removeBtn);
  container.appendChild(div);
  enableDrag(div, id);
});

function enableDrag(element, id) {
  let offsetX, offsetY;
  element.onmousedown = function (event) {
    offsetX = event.clientX - parseInt(element.style.left);
    offsetY = event.clientY - parseInt(element.style.top);
    function moveAt(e) {
      const x = (e.clientX - offsetX) / scale;
      const y = (e.clientY - offsetY) / scale;
      element.style.left = (x * scale) + 'px';
      element.style.top = (y * scale) + 'px';
      const updated = fields.find(f => f.id === id);
      if (updated) { updated.x = x; updated.y = y; }
    }
    function onMouseMove(e) { moveAt(e); }
    document.addEventListener('mousemove', onMouseMove);
    document.onmouseup = function () {
      document.removeEventListener('mousemove', onMouseMove);
      document.onmouseup = null;
    };
  };
  element.ondragstart = () => false;
}

document.getElementById('assign-fields-form').onsubmit = function () {
  if (!currentPdf) {
    alert("Aucun PDF sélectionné !");
    return false;
  }
  document.getElementById('fields-json').value = JSON.stringify({ pdf: currentPdf, fields: fields });
  document.getElementById('email-message-hidden').value = document.getElementById('email-message').value;
  document.getElementById('nom-demande-hidden').value = document.getElementById('nom-demande').value;
  return true;
};

function saveTemplate() {
  const name = document.getElementById('template-name').value.trim();
  if (!name || !currentPdf) return alert("Nom ou PDF manquant.");

  const templateFields = fields.map(f => {
    if (f.type === "statictext") {
      return { type: f.type, x: f.x, y: f.y, value: f.value };
    } else {
      return { type: f.type, x: f.x, y: f.y, signer_id: f.signer_id, email: f.email };
    }
  });

  fetch('/save-template', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: name,
      pdf: currentPdf,
      fields: templateFields
    })
  })
  .then(res => res.json())
  .then(data => {
    alert("Template enregistré.");
    fields = [];
    currentPdf = data.pdf;
    container.style.display = 'block';
    loadPDF('/uploads/' + currentPdf);
    setTimeout(() => {
      data.fields.forEach(field => {
        const id = fieldId++;
        field.id = id;
        fields.push(field);
        const div = document.createElement('div');
        div.className = 'field-box';
        if (field.type === "statictext") {
          div.classList.add('statictext-box');
          div.innerText = field.value;
        } else {
          div.innerText = field.type.toUpperCase();
        }
        div.style.left = (field.x * scale) + 'px';
        div.style.top = (field.y * scale) + 'px';
        let color = "#27348b";
        if (field.type !== "statictext") {
          color = COLORS[field.signer_id % COLORS.length];
        }
        div.style.border = `2px dashed ${color}`;
        container.appendChild(div);
        enableDrag(div, id);
      });
    }, 500);
  });
}

function loadTemplate() {
  const name = document.getElementById('template-select').value;
  fetch('/load-template/' + name)
    .then(res => res.json())
    .then(data => {
      fields = [];
      currentPdf = data.pdf;
      container.style.display = 'block';
      loadPDF('/uploads/' + currentPdf);
      setTimeout(() => {
        data.fields.forEach(field => {
          const id = fieldId++;
          field.id = id;
          fields.push(field);
          const div = document.createElement('div');
          div.className = 'field-box';
          if (field.type === "statictext") {
            div.classList.add('statictext-box');
            div.innerText = field.value;
          } else {
            div.innerText = field.type.toUpperCase();
          }
          div.style.left = (field.x * scale) + 'px';
          div.style.top = (field.y * scale) + 'px';
          let color = "#27348b";
          if (field.type !== "statictext") {
            color = COLORS[field.signer_id % COLORS.length];
          }
          div.style.border = `2px dashed ${color}`;
          const removeBtn = document.createElement('button');
          removeBtn.innerText = '×';
          removeBtn.className = 'remove-btn';
          removeBtn.onclick = function() {
            const index = fields.findIndex(f => f.id === id);
            if (index !== -1) fields.splice(index, 1);
            div.remove();
          };
          div.appendChild(removeBtn);
          container.appendChild(div);
          enableDrag(div, id);
        });
      }, 500);
    });
}
</script>

</body>
</html>
